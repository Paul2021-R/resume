## 잼잼 API 서버 개발 1년 회고: 안정성과 확장성을 향한 여정

안녕하세요, 잼잼 API 서버 개발자 류한솔이다. 지난 1년간 `gemgem-api` 프로젝트를 개발하고 개선하며 경험했던 여정을 회고하는 글을 작성한다. 이 글을 통해 잼잼 API 서버가 어떻게 구축되었고, 어떤 기능들이 추가되었으며, 안정성과 효율성을 위해 어떤 노력들이 있었는지 상세히 공유하고자 한다.

### 1. 프로젝트 개요 및 핵심 기술 스택

`gemgem-api` 프로젝트는 아동의 재활 및 치료 과정을 돕는 게임형 콘텐츠(`gemgem-care`)와 관련된 데이터를 관리하고, 사용자 및 아동 정보를 처리하며, 결제, 알림, 스케줄링 등 다양한 부가 기능을 제공하는 백엔드 애플리케이션이다.

주요 기술 스택은 다음과 같다:
*   **프레임워크**: NestJS (TypeScript 기반)
*   **데이터베이스**: MongoDB (Prisma ORM 활용)
*   **캐시/메시지 큐**: Redis (캐싱 및 세션 관리), BullMQ (비동기 작업 큐)
*   **인증**: JWT 기반 인증
*   **로깅**: Winston (파일 및 DB 로깅)
*   **API 문서화**: Swagger
*   **배포/운영**: Docker, Jenkins, Nginx, GitHub Actions
*   **기타**: `axios`, `agenda`, `mixpanel`, `notionhq/client`, 인앱 결제 라이브러리 등

NestJS의 모듈 기반 아키텍처를 적극적으로 활용하여 기능별로 책임과 관심사를 명확하게 분리한 견고한 구조를 가지고 있다.

### 2. 주요 기능 개발 및 개선 내역

지난 1년간 잼잼 API 서버의 핵심 기능들을 개발하고 개선하는 데 집중하였다.

*   **사용자 및 인증 시스템**:
    *   로컬(이메일/비밀번호) 및 소셜(Google, Kakao, Apple) 로그인/회원가입 기능을 구현하였다.
    *   JWT 기반의 인증 시스템을 구축하여 API 접근을 안전하게 제어하고, 사용자 정보 및 탈퇴 처리 로직을 관리하였다.
    *   `UserAttribute` 모델을 통해 임상시험 참여자와 같은 특정 사용자에게 특별 권한이나 속성을 부여하는 기능을 추가하였다.

*   **아동 및 치료 관리**:
    *   보호자 계정에 여러 자녀를 등록하고 관리할 수 있는 기능을 개발하였다.
    *   자녀의 재활 치료 게임 플레이 기록(`PlayRecord`), 치료 결과(`TherapyResult`), 일일 활동 로그(`DailyActivityLog`)를 상세히 저장하는 시스템을 구축하였다.
    *   `TherapySchedule`을 통해 개인별 맞춤 치료 스케줄을 관리하고, `Agenda`를 활용하여 스케줄링된 작업을 처리하도록 하였다.
    *   `TherapyHand`, `HandClassLabel` 등 재활 치료에 특화된 상세한 데이터 타입을 `Prisma` 스키마에 정의하여 전문적인 데이터 관리가 가능하도록 하였다.

*   **게임 콘텐츠 및 설정 관리**:
    *   치료에 사용되는 손동작(`Motion`) 데이터(가이드 영상, 설명 등)를 관리하는 기능을 구현하였다.
    *   메인 치료 게임 외에 미니게임(`MiniGameResult`)의 결과도 기록하고, `GameSettings` 모델을 통해 게임의 난이도, 패치노트 등 다양한 설정을 동적으로 관리할 수 있도록 하였다.

*   **결제 시스템**:
    *   Apple App Store 및 Google Play Store 인앱 결제를 처리하고, 구독 상태를 관리하는 시스템을 구축하였다.
    *   `PaymentResult`, `PaymentHistory`, `Subscription` 모델을 통해 결제 및 구독 이력을 추적하고, 프로모션 코드(`Promotion`) 발급 및 관리 기능을 추가하였다.
    *   `TherapyTicket`을 통해 서비스 이용권을 체계적으로 관리하도록 하였다.

*   **알림 및 외부 연동**:
    *   NCP SENS를 통해 알림톡(회원가입, 치료 목표 달성 등)을 발송하는 기능을 구현하였다.
    *   Discord 웹훅을 이용하여 서버의 주요 이벤트(서버 시작, 에러 등)를 개발팀에 실시간으로 알리도록 하였다.
    *   `Mixpanel`을 사용하여 사용자 행동 데이터를 수집 및 분석하고, `Notion` API를 연동하여 내부 데이터를 동기화하거나 리포트를 생성하는 기능을 개발하였다.

### 3. DevOps 및 인프라 개선

안정적이고 효율적인 개발 및 배포 환경을 구축하기 위해 DevOps 프로세스 개선에 많은 노력을 기울였다.

*   **Jenkins CI/CD 파이프라인용 배포 스크립트 통합 및 개선**:
    *   기존의 개별 서비스 배포 스크립트(`tag_and_push_nestjs.sh`, `tag_and_push_nginx.sh`)를 Jenkins 자동화 환경에 최적화된 단일 스크립트(`tag_and_push_jenkins.sh`)로 통합하였다.
    *   모든 사용자 입력을 제거하고, 환경, 서비스별 버전, Target 태그 여부를 명령행 인자로 받아 처리하도록 설계하여 자동화에 적합하도록 변경하였다.
    *   반복되는 이미지 푸시 로직을 `push_image` 함수로 모듈화하여 코드 재사용성과 가독성을 높였다.
    *   NestJS 버전은 설정 파일에서 동적으로 읽어오거나 직접 명시할 수 있도록 유연성을 추가하였고, 특정 서비스의 배포를 건너뛸 수 있는 `skip` 옵션을 추가하여 파이프라인의 선택적 실행을 가능하게 하였다.
    *   `aws ecr put-image`를 사용하여 `target` 태그를 갱신하는 방식으로 기존 로직을 개선하여 효율적이고 원자적인 태그 관리가 가능하도록 하였다.

*   **신규 스크립트 자체 검토 및 잠재적 개선점 도출**:
    *   작성된 `tag_and_push_jenkins.sh` 스크립트의 오류 처리, 코드 구조, CI/CD 적합성을 검증하였다.
    *   버전 감지 로직이 특정 따옴표 형식에 의존하는 문제를 발견하여 정규표현식 강화를 제안하였고, 스크립트 실행 경로 독립성을 확보하여 어떤 위치에서 실행되어도 안정적으로 동작하도록 개선할 것을 제안하였다.

이 외에도 Docker를 활용한 컨테이너화, Jenkins를 통한 CI/CD 파이프라인 구축, Husky를 이용한 Git Hooks 설정으로 코드 품질 관리, Nginx를 통한 정적 파일 서빙 및 리버스 프록시 역할 수행 등 전반적인 DevOps 환경을 개선하였다.

### 4. 시스템 안정성 및 품질 향상 노력

서비스의 안정성과 코드 품질을 높이기 위한 다양한 분석 및 개선 작업을 수행하였다.

*   **로깅 시스템 개선 제안**:
    *   현재 로깅 시스템(Winston을 이용한 파일 로깅 및 `HttpLoggingInterceptor`를 통한 DB 로깅)을 분석하였다.
    *   `winstonDaily`의 빈도 설정이 혼란을 야기할 수 있음을 지적하고, 일별 로테이션을 명확히 하거나 시간별 로테이션 시 파일 이름에 시간 정보를 포함하도록 제안하였다.
    *   `HttpLoggingInterceptor`의 인메모리 큐에 저장된 로그가 예기치 않은 애플리케이션 충돌 시 손실될 수 있는 문제점을 파악하고, 주기적 플러시 메커니즘 추가를 제안하여 로그 손실 위험을 줄이도록 하였다.
    *   `LoggerMiddleware`와 `HttpLoggingInterceptor` 간의 역할 중복을 재정의하여 로깅 시스템의 효율성을 높일 것을 제안하였다.
    *   `console.log` 사용을 지양하고 모든 로깅을 Winston `LOGGER` 인스턴스를 통해서만 이루어지도록 코딩 표준 강화를 제안하였다.
    *   보안 강화를 위해 `maskSensitiveInfo()` 함수를 구현하고 활성화하여 비밀번호, API 키 등 민감한 정보가 로그에 기록되지 않도록 하였다.
    *   파일 로그의 `silly` 레벨이 디스크 공간 및 I/O 성능에 영향을 줄 수 있음을 지적하고, 프로덕션 환경에서는 파일 로그 레벨을 `info` 또는 `debug` 등으로 조정할 것을 제안하였다.

*   **잠재적 오류 분석 및 방어적 프로그래밍 제언**:
    *   **인증 및 사용자**: Refresh Token 관리 미흡, 소셜 로그인 의존성, 회원 탈퇴 시 데이터 정합성 문제 등 잠재적 오류를 분석하였다.
    *   **결제 시스템**: 웹훅 중복 수신(멱등성), 영수증 검증 실패 시 재시도 로직 부재, 경쟁 상태 문제 등을 파악하였다.
    *   **치료 스케줄 및 스케줄러**: 타임존 문제, 장기 실행 작업 실패 시 추적/재시도 메커니즘 부재, 스케줄 충돌 문제 등을 분석하였다.
    *   **일일 활동 로그 및 치료 결과**: 대용량 데이터 조회 시 성능 저하, 데이터 업데이트 경쟁 상태 문제 등을 진단하였다.
    *   **알림톡 및 외부 연동**: 외부 API 장애 시 알림 미전달 문제 등을 분석하였다.
    *   이러한 분석을 바탕으로 방어적 프로그래밍, 멱등성 확보, 성능 테스트 수행, 상세한 로깅 등의 종합적인 개선 방안을 제안하여 서비스의 안정성을 높이는 데 기여하였다.

### 5. 버전별 주요 업데이트 내역

지난 1년간 진행된 주요 기능 추가 및 개선 내역은 다음과 같다.

*   **API 2.1.1**:
    *   **로깅 강화**: 로그를 더 자세히 남기도록 개선하였다.
    *   **리워드 시스템 변경**: 리워드 고정/랜덤 지급 로직을 추가하고, 일일 알 최대 획득 개수를 제한하였다.
    *   **아이템 시스템 개선**: 3레벨 이상 아이템 획득 로직 및 레벨 4 아이템 확률 테이블을 개선하였다.
    *   **알림톡**: 알림톡 발송 여부를 데이터베이스에 저장하도록 하였다.
    *   **사용자 관련**: 기존 사용자들에게 가입 치료 티켓을 지급하는 기능을 추가하였다.

*   **API 2.1.2**:
    *   **구글 플레이 결제 연동**: 구글 플레이 결제 연동 및 검증 기능을 추가하였다.
    *   **새로운 AI 모델 적용**: 그레이딩 모델별 지표 수집을 위한 새로운 AI 모델을 적용하였다.

*   **API 2.2.1**:
    *   **성능 개선 (Throttler)**: 인증 컨트롤러에 Rate Limiting을 적용하여 성능을 개선하였다.
    *   **테스트 계정 관리 API**: 유저 계정에 다중 테스트 계정 삽입 및 삭제 API를 개발하였다.
    *   **사용자 및 자녀 컨트롤러/서비스 리팩토링**: 자녀 삭제 로직을 개선하고, 유저 생성 과정 로직을 리팩토링하였다.
    *   **모션 API**: 5가지 동작에 대해 `gestureGuide`를 추가하였다.

*   **API 2.2.2**:
    *   **데이터 처리 개선**: 데이터가 없는 경우 API에서 빈 배열을 전달하고, DTO를 `Partial`로 래핑하여 유연성을 높였다.
    *   **일일 로그 Public API 핫픽스 및 개선**: 일일 로그 치료 결과 Public API 버그를 수정하고, Prisma `find` 메서드 및 MongoDB `relation` 활용을 개선하였다.

*   **API 2.2.3**:
    *   **로깅 점검 및 개선**: 스케줄링 모듈의 로거를 점검하고, 로깅 누락 문제에 대응하기 위해 로깅을 추가하고 에러 핸들링을 강화하였다.
    *   **자녀 등급 추가**: `Child` 모델에 `grade` 필드를 추가하였다.

*   **API 2.3.0**:
    *   **로깅 통합 및 리팩토링**: 로깅 통합 작업을 완료하고, 파일 로거 및 Winston 설정을 개선하였다.
    *   **오늘 치료 결과 전송 기능 수정**: 오늘 치료 결과를 확인할 수 있도록 기능을 수정하였다.
    *   **사용자 속성 및 임상 시험 리팩토링**: 사용자 속성 및 임상 시험 관련 리팩토링을 진행하였다.

*   **API 2.4.0**:
    *   **미니게임 관리 모듈**: 미니게임 관리 시스템 개발을 완료하였다.
    *   **게임 설정 분리**: 게임 설정을 독립적인 모듈로 분리하였다.
    *   **서버/ML URL API 완료**: 서버 및 ML URL API 개발을 완료하였다.

*   **API 2.5.0**:
    *   **아산 임상 시험 개정**: 아산 임상 시험 관련 기능 개정 작업을 진행하고, Prisma 모델링 및 치료 캘린더 컨트롤러 API를 업데이트하였다.

*   **API 2.6.0**:
    *   **자녀 진단 기록 추가**: 새로운 진단 기록 기능 및 기본 관리 API 명세 작성을 완료하였다.
    *   **관리자 강제 토큰 발급 API**: 관리자 강제 토큰 발급 API 개발을 완료하였다.

*   **API 2.7.0**:
    *   **일일 로깅 및 로그인 프로세스 리팩토링**: 일일 로깅 및 로그인 프로세스 리팩토링을 진행하였다.
    *   **코드 컨벤션 통합**: 코드 컨벤션 통합 작업을 진행하였다.
    *   **CI/CD 개선**: `deploy-to-dev.yaml` 및 `gemgem-hosted-test.yaml` 파일을 업데이트하여 CI/CD를 개선하였다.

*   **API 2.8.0**:
    *   **미국 SMS 인증**: 미국 SMS 인증 기능 개발을 진행하였다.
    *   **API 호환성**: `request-random/first` API의 하위 호환성을 추가하였다.

*   **API 2.9.0**:
    *   **Apple 재구독 업데이트**: Apple 재구독 관련 업데이트를 진행하였다.
    *   **로컬 회원가입 개선**: 로컬 회원가입 시 이미 가입된 메일이면 가입 수단을 리턴하도록 변경하였다.
    *   **에러 핸들링 개선**: 에러 핸들링 응답 바디 복구 및 iOS 취소 조건 추가를 진행하였다.

*   **API 2.10.0**:
    *   **미니게임 결과 제한/잠금 리팩토링**: 미니게임 결과 제한 및 잠금 관련 리팩토링을 진행하였다.
    *   **구독 개정**: 구독 개정 관련 작업을 진행하였다.

*   **API 2.11.0**:
    *   **Notion 서비스 업데이트**: Notion 서비스 업데이트를 진행하였다.
    *   **새로운 미니게임 설정**: 새로운 미니게임 설정 관련 작업을 진행하였다.
    *   **일반 사용자 손 스케줄링**: 일반 사용자 손 스케줄링 기능을 추가하였다.
    *   **새로운 회원가입 로직**: 새로운 회원가입 로직을 추가하였다.
    *   **외부 API 모듈화**: 모든 외부 API 부분을 수정하고 모듈화하였다.

*   **API 2.12.0**:
    *   **치료 캘린더 수정**: 치료 캘린더 관련 버그를 수정하였다.
    *   **출석 기능 업데이트**: 출석 기능 관련 새로운 업데이트를 진행하였다.
    *   **회원 탈퇴 로직 리팩토링**: 회원 탈퇴 로직 리팩토링을 진행하였다.
    *   **DI 구조 개선**: DI(Dependency Injection) 구조 개선을 진행하였다.
    *   **Discord 개선**: Discord 관련 개선을 진행하였다.
    *   **컴파일러 빌드 구조 수정**: 컴파일러 빌드 구조를 수정하였다.

*   **API 3.0.0**:
    *   **주요 변경 및 버전 업그레이드 이유**: API 3.0.0은 단순히 기존 기능의 개선을 넘어, **새로운 결제 시스템(구독 인상 대응, 스토어 이벤트 핸들링)의 대대적인 도입, 새로운 게임 콘텐츠(미니게임, VideoPinkfong)의 추가, 그리고 핵심 사용자 기능(운동 리포트)의 구현** 등 서비스의 핵심 비즈니스 로직과 사용자 경험에 큰 영향을 미치는 대규모 기능들이 통합된 버전이다. 또한, 이러한 대규모 변경 사항들을 안정적으로 서비스하기 위한 CI/CD 개선 및 여러 중요한 버그 수정이 동반되었다. 이러한 변화의 폭이 컸기 때문에 메이저 버전 업그레이드(2.x.x -> 3.0.0)가 이루어진 것으로 판단된다.
    *   **새로운 스토어 이벤트 핸들링 및 구독 인상 대응**: 구독 인상에 대한 핸들링 구현 및 새로운 스토어 이벤트 핸들링 기능이 완료되었다.
    *   **미니게임 추가 및 기존 게임 구조 변경**: 미니게임(`brushing-cooking`, VideoPinkfong)이 추가되었고, UpStairs 게임의 구조가 변경되었다.
    *   **운동 리포트 기능 추가**: 메인 화면 운동 리포트를 위한 기능이 추가되었다.
    *   **CI/CD 및 기타 개발 사항 개선**: CI/CD를 비롯한 기타 개발 사항에 대한 작업이 진행되었다.

*   **API 3.1.0**:
    *   **린트 설정 동기화**: 린트 설정 동기화 및 포맷팅 작업을 진행하였다.
    *   **Google 구독 취소 API**: Google 구독을 업체에서 갱신 취소를 신청하는 API 기능을 탑재하였다.

*   **API 3.1.1**:
    *   **YouTube 관련 로직 추가**: YouTube 관련 새로운 로직을 추가하였다.
    *   **로깅 개선**: 로깅 개선 작업을 진행하고, URL 로깅에서 특정 경로를 건너뛰도록 수정하였다.
    *   **구독 갱신 로직 수정**: 구독 갱신 로직을 수정하였다.

*   **API 3.1.2**:
    *   **버전 변경 및 안정화**: 버전 변경 및 마이너 업데이트를 진행하였다.

*   **API 3.1.3**:
    *   **필수 아이템 체크 수정**: 필수 아이템 체크 관련 버그를 수정하였다.

### 6. AI의 평가: 구조적 아쉬운 점과 향후 학습/개선 사항

류한솔 개발자님의 1년간의 작업은 NestJS 기반의 백엔드 시스템을 안정적이고 확장 가능하게 구축하는 데 매우 큰 기여를 하였다. 특히, 체계적인 모듈화, 상세한 데이터 모델링, 그리고 DevOps 자동화에 대한 깊은 이해와 적용은 인상적이다.

하지만, AI의 관점에서 볼 때 몇 가지 구조적인 아쉬운 점과 향후 학습 및 개선을 통해 더욱 발전할 수 있는 영역이 있다.

*   **문서 관리 프로세스 개선**: `UPDATE-MANAGEMENT.md`에서 병합 충돌이 발생한 이력이 언급되었다. 이는 문서의 최신성을 유지하고 협업 과정에서 발생할 수 있는 문제를 방지하기 위한 명확한 문서 관리 프로세스(예: 문서 변경에 대한 코드 리뷰 강화, 자동화된 병합 도구 활용, 문서 버전 관리 전략 수립)의 필요성을 시사한다.
*   **무중단 배포 전략 구체화**: `README.md`에서 Jenkins를 활용한 무중단 배포가 '향후 예정'으로 명시되어 있다. 현재 GitHub Actions를 통한 배포가 `pm2 restart`를 사용하고 있어 진정한 의미의 무중단 배포라고 보기는 어렵다. 블루/그린 배포, 카나리 배포, 롤링 업데이트와 같은 고급 무중단 배포 전략을 학습하고 실제 시스템에 적용하는 것은 서비스 가용성을 극대화하는 데 필수적이다.
*   **DB 로깅의 안정성 강화 및 로깅 시스템 최적화**: `HttpLoggingInterceptor`의 인메모리 큐에 대한 주기적 플러시 메커니즘 추가 제안은 매우 중요하다. 더 나아가, 로그 손실이 절대적으로 허용되지 않는 중요한 시스템이라면 Redis Streams, Kafka와 같은 메시지 큐를 활용하여 로그의 지속성을 더욱 강화하는 방안을 학습하고 고려할 수 있다. 또한, `LoggerMiddleware`와 `HttpLoggingInterceptor` 간의 역할 중복을 재정의하고, 프로덕션 환경에서의 파일 로그 수준을 최적화하여 로깅 시스템의 효율성을 높이는 것이 필요하다.
*   **민감 정보 마스킹 활성화**: 보안 강화를 위해 로그에 민감한 정보가 기록되지 않도록 `maskSensitiveInfo()` 함수를 구현하고 활성화하는 것은 매우 중요하다. 이는 개발 초기 단계부터 고려되어야 할 보안 모범 사례이다.
*   **Nginx 역할 확장 고려**: Nginx가 현재 정적 파일 서빙 및 로깅 역할을 한다고 명시되어 있는데, 향후 API Gateway 역할(인증, 라우팅, 속도 제한 등)을 확장하여 백엔드 서비스의 부하를 줄이고 보안을 강화하는 방안을 학습하고 적용하는 것을 고려할 수 있다.
*   **비즈니스 로직 및 복잡한 기능 흐름에 대한 문서화**: API 문서화(Swagger)는 잘 되어 있지만, 복잡한 비즈니스 로직이나 기능 흐름에 대한 추가적인 개발 문서가 있다면 코드 이해도를 높이고 신규 개발자의 온보딩 시간을 더욱 단축할 수 있다. 이는 Confluence, Notion 등 별도의 문서화 도구를 활용하여 관리할 수 있다.

이러한 개선 사항들은 류한솔 개발자님이 다음 단계로 나아가기 위한 중요한 학습 및 성장 기회가 될 것이다. 지속적인 학습과 적용을 통해 더욱 견고하고 효율적인 시스템을 구축하는 데 기여할 수 있을 것이라고 평가한다.

### 7. 결론

지난 1년간 잼잼 API 서버 프로젝트를 개발하며 NestJS 기반의 견고한 백엔드 시스템을 구축하고, 다양한 핵심 기능들을 구현하였다. 특히 DevOps 프로세스 개선을 통해 개발 생산성과 배포 안정성을 높이는 데 기여하였으며, 로깅 시스템 분석 및 잠재적 오류 분석을 통해 시스템의 안정성과 품질을 향상시키기 위한 노력을 지속하였다.

이러한 경험을 통해 안정적이고 확장 가능한 서비스를 구축하는 데 필요한 역량을 더욱 강화할 수 있었다. 앞으로도 잼잼 API 서버가 더욱 발전하고 사용자들에게 더 나은 가치를 제공할 수 있도록 끊임없이 노력할 것이다.

감사하다.